import { getNotFoundResponse } from "@@/server/utils/response";
import { existsSync, createReadStream } from "fs";
import { getRouterParam, appendHeader } from "h3";
import config from "@@/server/config";
import mime from "mime";
import path from "path";
import { useFileStorage } from "@@/server/utils/useFileStorage";

const defaultImage = Buffer.from(
  "iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAAAXNSR0IArs4c6QAAE21JREFUeF7tnWly3DYQRsmy7mH5JJZPkugQYpV+yf7lKuoQkU6S8Ums3GNYTCCTMTWaBQ009jdVriwGsbzu/gg0QbDv+EEAAs0S6JsdOQOHAAQ6BAAngEDDBBCAho3P0CGAAOADEGiYAALQsPEZOgQQAHwAAg0TQAAaNj5DhwACgA9AoGECCEDDxmfoEEAA8AEINEwAAWjY+AwdAggAPgCBhgkgAA0bn6FDAAHAByDQMAEEoGHjM3QIIAD4AAQaJoAANGx8hg4BBAAfgEDDBBCAho3P0CGAAOADEGiYAALQsPEZOgQQAHwAAg0TQAAaNj5DhwACgA9AoGECCEDDxmfoEEAA8AEINEwAAWjY+AwdAggAPgCBhgkgAA0bn6FDAAHAByDQMAEEoGHjM3QIIAD4AAQaJoAANGx8hg4BBAAfgEDDBBCAho3P0CGAAOADEGiYAALQsPEZOgQQAHwAAg0TiCIA4zj+2XXd567rbhbW1w0zZ+gQMARezJ++73dd1/3Y7/cv9/f35v9F/QUTgMfHx4d5nk3gE+xRTUpjBRPYTdN0G1MI1AVguds/EPgFuyFdT03gaZqmbzGEQE0Avn//fv3hw4e/NtP81BBpHwKlE7gdhuEp5CBUBODx8fFmnue/Q3aUuiHQIoG+77/u9/vnULMBbwFYpvzmzs8PAhAIQyBYbsBLALjzh7E2tULgkICZCdzd3X3TJuMsAMua/6d2h6gPAhA4TiCECDgLwDiOZs2/PtfHZhCAQAQC0zR90swHOAkA6/4IlqYJCBwnsBuG4YsWHFcBMFN/NvhoWYF6ICAjoPZ4UCwAyw6/r7L+UhoCEFAkoDYLEAsAa39FM1IVBBwJaOUCRAJA5t/RWlwGAX0CKssAkQDw3F/fitQIAUcCKssAqQCYN/xY/ztajMsgoElgGAZR/B5rW1TBOI5my695xZcfBCCQmIBGHkAqAGz+SWx0mofASiCFAPD8H/+DQCYE+r7/cnd3Z04Ucv5JZwAIgDNqLoSALgEEQJcntUGgKAIIQFHmorMQ0CWAAOjypDYIFEUAASjKXHQWAroEEABdntQGgaIIIABFmYvOQkCXAAKgy5PaIFAUAQSgKHPRWQjoEkAAdHlSGwSKIoAAFGUuOgsBXQIIgC5PaoNAUQQQgHjmMi9cvH66ue/7l3me/+n7/qP573met58856DUeDZpviUEIJwLmA8y/pimaSc5g90cmXZ1dXU9z/P6dWQEIZyNmq8ZAdB1gae+7599X6/cdmk5Qu2P5QMqiIGuvZqvDQHQcYFd3/ffNAP/sFuLEJhZAV9S0rEZtfxajnIegIcnBA98hMDDOlx6kQACcBHR8QIhPrIo6crycRVztiLLAgk4yr4hgAA4OIQGNIdm312yLAvMIauIgAbQBuvQ8OWWjgR76fv+NuRaX+qDy4dWzEGriIAUHuXJAQh8QOUjCoL2REU5bl2Ei8ILAWYAdq7wMgzDJ7ui6UqN48iBq+nwF9kyAnDZbC/TNH2RbOa5XGWYEiwHwnCtuVYE4IJ1NQDFdCBEICbt8tvS8O9qk4CpH/W5utfyiJDvL7oCbOg6BOC0sYtY95/qPknBhqLYY6gIwAl4GmA87OJ9KUsBb4RNVKDh5zUuAbJ+5GfrmSwFbEm1Ww4BOGJ7jS+m5uBSzAJysELefUAA3tunirv/OixmAXkHYOreIQAHFtAAktqo2/aXWYDZIMQPAu8IaPh7TTmAojP/Z54IsEOQ4D9KAAHYYCn1uf8l32YZcIlQu3+PALQhADfzPJs3BvkVQMAE5TzPUV7zRgA2DjEMg2g5U4Av/d9FXhQqwlr/v24e66wHBOC3X1S5/l+Hx87A7AXg3VkTMZZuCMBvv3gahuE2ezdx7CAC4AguzmUnD5oJPXNDABYD15oAXP03xt0kTqxU18rZmWfozVwIQCMCMI6jOUDUJJb45UPAatkZUrwRgEYEYEkq8SQgn+AX7TgNJQIIwG8B8P5AQj6+9b4nCEBW1hEF/yaRq76hCwH47Re3wzCY7/lV+UMAsjGrU/Cb3od4NIgANCIA5ACyEADn4A+VzEUAGnkMGGoNmUVYldEJ7+APsRRAABCAMsKn7F6q7jHRfDSIAPx2LDWFztFX2QiUzCqqwa+9FEAANn5Ry0lAx1x9HMc5WQg02nDozWUayzoEYOOcGjBy9HUOBUlilShPlXy3Cmv4vOgNOt8OhzRlaMUO2fdzdWvcKVL1vdB2owS/YeObD0AA3npYlXmAcRzNDsCbQoOpqG5rBJR0wD4Cr9HfamYABnxteQCm/9Jwci+vEUyurbvOrDX6XJUA1LYM8Lk7uDpji9dpBJIPNwTAh97BtTXNAsj+KzrGiapSB7/pFgKgaOdaZgHc/RWdIuPgRwAC2Ln0WQBr/wBO8bbKk6f4BG/5SAPMAJSplz4L4O6v7BAZBz8zgEC2LnUWwN0/kEP8qjarO/86UmYAYWz+Mk3Tl/v7+5cw1evX6rsxRL9HVdVodYRXihEjAOGoFyUCbPoJ5gjZBj9LgGA2/1VxKfkA3vgL5gjZ7xBlBhDM9mWIACf+BHOA7IOfGUAw27+t2MwE9vv9c245Ae78wRygiOBHAILZ/2jFu2mabnMRAdb8wYxfTPAjAMF84GTFyRODIU6IjY8x2xaLCn4EIJEfpVoSsMknqMGLC34EIKg/WFV+O03TLvSyYEn0PXRdd23VKwpJCQQ5v0/aCZfyPAVwoaZ/TRAhIPD1DXWkxmKDnxlAFP8QNbLr+37n88RgCfrP/209NR/15BeQQCn7PM4hYAYQ0EE8q94t+8fX7cQ/TH37/f7l6urqep7n1+l83/cfl383R3cxxfeELrg82vl9gj6JiyIAYmRcAIGuiuBnCYAnQ0BIIIdTfIRdPlucGYAmTeqqmkBtwc8MoGp3ZXCaBGoMfgRA00Ooq1oCtQY/AlCtyzIwLQI1Bz8CoOUl1FMjgSyP8NIGTRJQmyj11UCgieBnBlCDqzIGbQLNBD8CoO061Fc6gazP7wsBlyVACKrUWSKB5oKfGUCJbkqfQxAo8l1+DRDMADQoUkfJBJoNfmYAJbstfdcg0HTwIwAaLkQdpRJoPvgRgFJdl377EiD4F4LkAHxdietLI1D0EV7asBEAbaLUlzMBgv/AOghAzu5K39QI1HB+nxqMTUUIQAiq1JkbgWqO8NIGiwBoE6W+3AgQ/GcsggDk5q70R41A7e/ya4BCADQo5l3Heqx4U0eGE/x2TokA2HEqtdTrq61d132e59l8KKQJESD47d0VAbBnVVrJN18ibuXDoAS/3E1dPiGnwbmXdNVVqSRtVFT26KuttYuAhlNW5APioUiEQIM1AiA2kdUFZ99rr1QEmjrFx8oLPArZCAEC4AE44KVWh1pUJgIEfyCHGsfxr67rjn5zEgEIBN2jWqvgX+tfjFv6F4SbDf7v37+/S+je39+vT3w83OjtpY+PjzfzPBsheNMeAqCGWKUip7fbCs+rvElyqlDMrJIl+Ezgmc+9m3+uf8711HxV2nw12vzzh/matK8wGLH58OHD31sRQADycRan4N/MBH4W+HhQNNvJx1SXe7Ksv03Aa87OdkYQ9vv9s48YbGeNCMBlW8Yo4RX8poPH1D1Gxz3a8B6zR9tBLl3u9H8oB/2pvpqZwfM0TTsXMVjyR3+a/SV3d3evsw3XH08BXMn9uk4tEAoSAbUx+6HXuXq525vAN4m2FL9bFyEwgqWxtEAA3E2uHggFiID6mN3x+1253PEfEgb+4QCchMCPQtchAG4EgwXCqYyvWzdVrwo2ZtVeWlSW8dMXkyf45jutt0DwfxEEQEJLedp/qul1jZdRYrCK4F/E1WTSs/6Zg1N8k4W2A0QAbElFCv61OxmJQC3B/zDP81eZuZOW3k3TdOuSJJT0GgGwpxU9EDLYLVjF+X3jOJq7fqokn72HvS8ZfJ8FAmBnnujBfzATSHHnKj74l6TqupXWztJ5lgp2ohICcNngyYI/lQjUcHhnRcG/ukEQEUAAzgtANnfBiJnrII52WWd1SxQ87T8JYpqmT9o5AQTgtN9lE/xrFyO8N0Dw6+qQem3aIoAAHDdRdsEfWgQ09pWre7tDhRkkTh16LbpENTGIALxnn23wm66G2C1YUfCb12azf84vCvcjhTVzNAjAW8BZB//aVU0RqCX4FybmrcqYvyfzum/f9x+XA19N21EOfdUSAQRgcRctoLG8T0MEagl+wzxm0u+Ur8Texq2RD0AAfkVskckvHxGoKfhjbvG14RYhWbveZ7wfUSMAhQb/JiloDq0wb7XZTj2rO8IrVsDZzhJjCpLvzat1ASjyzn+4zBC8N1Bd8MfM+g/DYB0vEfdteD0VsB7Qss4q8eiqU8vyKoJ/HZxFIFQX/ItPzpHyLqIj0JaDRsw25Bg/Z19uVQCcgcWwpmsbZ0RA5Lyu7ce+zkL0NLskWm9HFgBR37ZQmhMAmySOptfErutIUFQZ/AlmpKJHxJHzAJ3rE4GmBKD24N8kBs3U0yQHne8MsYVL2l6C5/4ilpFnAAafSKBW3s0IQCvBv80J3N3dfZMGVinlI0//DRaRACTon9MsoAkBaC34Swlin36O4xgr+bd2U7SUSiEALn5evQC4QPFxTK4NTyDB9P91UJLHgCkEwGUZULUAEPzhgzFFC4mCSyQAEfcBbE0gWqaYC6sVAII/RWjGaTOVAEgy7THfTdhSl/SxWgEg+OMEYqpWEqz/X4cqCa5UAiD1/epmAFIAqZyYdt0JpBIAiW/Fej/hCEXRJreqBEBiIHf348qUBFIlAF+ny33/xfarPQkFQLQfoBYBqHKfe8pAy7Xt2DvsDjhY311TzVKkTwJqEACCP9doDdCvBDvstqMoQQBETwJKFwCCP0CQ5VxlSgGwPQ8g5TJFumOxZAEg+HOO1EB9S/UIcBmO1fo6sQCIdiyWKgAEf6AAy73aEgQgcZ6iegEg+HOP0oD9S7kEsE2wIQDhHECkbuG6Qc2pCCQWAKsEWwl9XO1X0hKA4E8VdRm1m/juaiUAiZcpVn0sTQAI/oyCMGVXEguA1XbglAJg+6SiJAEg+FNGXIZtJ9xkYyUACXcBmt2KXyUHweS+BCD4MwzA1F1KGWD/HbV29hjulHd/6Xbl1/ISY0YGL1rLSMZB2bIJJHrXfgvtaZqmb/f39y/b/5k4+ffaFcmhJTkLAMFfdowG7X0OgWZmAuZP3/e7eZ7NV5luBF9nCsVHPGPOcQZA8Idyj0rqTZ0IzBWjdP2f4wyA4M/VuzLrV+TlaGajP94dyevKOT4FIPiLcLM8OplBHiAPEL97IZ7+5zQDIPhzc6fM+5PBMmDXdd3zBtPn5WMsSci5TP9dBODvJdmhOUiCX5NmQ3UlXAYcfStwESXzVSbbT7WrWUtyXuG2UWkScP3klFbHCX4tkg3Wk+iZ+1mfTdQnp+m/eAagPLjdNE23DfotQxYQOHzWfnhp7FmAzXP2BCcCW59UdMhPNAPIYN0lcB2KVkDg4gEcyjelS8is7rSRE5RWfTo1MJEAmEpiK+4li/D3dROwWdvG9EmbGUBMUXJ59OecA1gEQDsPULcHMzovAjbZ7ZgBZylIIZLlxzh659DEM4DlvDMzwOiZTi9P4uJiCVgG3c8YPnlJkGKeB2jD5ZLRxQLALOASUv5em8CloDPtxbwxnZp2L30wM2TzXkDQnw0Tmw44CUBM2DaDoEz9BGzudjGXAuZ8wL7vn/f7/cvV1dX18kKQCf4YP++p/9pJJwEwF0eGHQMqbeRN4Ox7+GvXG/BLr6z/oYmdBYClQN7RUmPvbKe9MZ8KxObsm/VXFYBFBKIkX2KDpr08CdgsBWr1S+3gN5y8ZgCxky95uiS9ikzAailQW54qRPCrCMBq/Mi7nyL7HM3lRMB2KVCLCIQKflUB2CQG/4zxPDYnh6Qv8QnYikDhuargX8HyXgIcM/0yG8jhjLT4nkmL0QhIRGB5OlDSzen1ZblLL0P5wg4iAGtu4Orq6o95nlchYOegr7W4/h0BoQjczPOc5H19iekkY5LUe6xsMAE4bGx5k/C67/uP5u+WjRO+/ed6CJiPdbw7ovsUliUv8JDy9J4zJgs+5T9sO5oA4KcQyIlAytN7TnBwfqffhysC4EOPa4snsAiBmREE379/dAou/JSXNnAEQJso9RVJYCMEJlcVOl/1eqDoMAxPqWEhAKktQPvZEQgkBibYf0zTtAud2ZcARQAktCjbHAEjBl3XfV6S1uvs4NIMwdzhTULvZZ7nf3K4058yHALQnEszYA0C5mnCYT053dltx4gA2JKiHAQqJIAAVGhUhgQBWwIIgC0pykGgQgIIQIVGZUgQsCWAANiSohwEKiSAAFRoVIYEAVsCCIAtKcpBoEICCECFRmVIELAlgADYkqIcBCokgABUaFSGBAFbAgiALSnKQaBCAghAhUZlSBCwJYAA2JKiHAQqJIAAVGhUhgQBWwIIgC0pykGgQgIIQIVGZUgQsCWAANiSohwEKiSAAFRoVIYEAVsCCIAtKcpBoEICCECFRmVIELAlgADYkqIcBCokgABUaFSGBAFbAgiALSnKQaBCAghAhUZlSBCwJYAA2JKiHAQqJIAAVGhUhgQBWwIIgC0pykGgQgL/AgYyOqb0xmmVAAAAAElFTkSuQmCC",
  "base64"
);

export default defineEventHandler(async (event) => {
  const slug = getRouterParam(event, "slug");

  if (!slug) {
    appendHeader(event, "Content-Type", "image/png");
    return defaultImage;
  }

  const storage = useFileStorage();

  const exist = await storage.exists(slug);

  if (!exist) {
    appendHeader(event, "Content-Type", "image/png");
    return defaultImage;
  }

  const filePath = await storage.getPath(slug);

  appendHeader(
    event,
    "Content-Type",
    mime.getType(filePath) ?? "application/octet-stream"
  );

  return await storage.read(slug);
});
